@page "/Account/VerifyIdentity"
@model Mirrorly.Pages.Account.VerifyIdentityModel
@{
    ViewData["Title"] = "Xác minh danh tính";
}

<style>
    .verify-container {
        max-width: 800px;
        margin: 40px auto;
        padding: 30px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .verify-header {
        text-align: center;
        margin-bottom: 40px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e5e7eb;
    }

    .verify-title {
        color: #1e293b;
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .verify-subtitle {
        color: #64748b;
        font-size: 16px;
    }

    .verification-steps {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 40px;
    }

    .step {
        text-align: center;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #e5e7eb;
    }

        .step.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .step.completed {
            border-color: #10b981;
            background: #ecfdf5;
        }

    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        margin: 0 auto 10px;
    }

    .step.active .step-number {
        background: #3b82f6;
        color: white;
    }

    .step.completed .step-number {
        background: #10b981;
        color: white;
    }

    .form-section {
        margin-bottom: 40px;
        padding: 30px;
        background: #f8fafc;
        border-radius: 12px;
        border-left: 4px solid #3b82f6;
    }

    .section-title {
        color: #1e293b;
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .form-group-full {
        grid-column: 1 / -1;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #374151;
        font-weight: 600;
    }

    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
        box-sizing: border-box;
    }

        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

    .file-upload {
        position: relative;
        display: inline-block;
        width: 100%;
    }

    .file-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }

    .file-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        min-height: 150px;
    }

        .file-label:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .file-label.has-file {
            border-color: #10b981;
            background: #ecfdf5;
        }

    .file-icon {
        font-size: 48px;
        margin-bottom: 10px;
        color: #9ca3af;
    }

    .file-text {
        text-align: center;
        color: #6b7280;
    }

    .file-preview {
        max-width: 200px;
        max-height: 150px;
        border-radius: 8px;
        margin-bottom: 10px;
    }

    .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        font-size: 16px;
    }

    .btn-primary {
        background: #3b82f6;
        color: white;
    }

        .btn-primary:hover {
            background: #2563eb;
        }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

        .btn-secondary:hover {
            background: #4b5563;
        }

    .alert {
        padding: 16px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-weight: 500;
    }

    .alert-success {
        background: #ecfdf5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }

    .alert-error {
        background: #fef2f2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    .alert-warning {
        background: #fffbeb;
        color: #92400e;
        border: 1px solid #fed7aa;
    }

    .requirements {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #f59e0b;
        margin-bottom: 20px;
    }

        .requirements h4 {
            color: #92400e;
            margin-bottom: 15px;
        }

        .requirements ul {
            margin: 0;
            padding-left: 20px;
        }

        .requirements li {
            margin-bottom: 8px;
            color: #374151;
        }

    
</style>

<div class="verify-container">
    <div class="verify-header">
        <h1 class="verify-title">🛡️ Xác minh danh tính</h1>
        <p class="verify-subtitle">
            Để tăng độ tin cậy và bảo mật, vui lòng hoàn thành quy trình xác minh danh tính
        </p>
    </div>

    @if (Model.ExistingVerification != null)
    {
        <div class="alert @(Model.ExistingVerification.Status == 1 ? "alert-success" :
                                        Model.ExistingVerification.Status == 2 ? "alert-error" : "alert-warning")">
        @if (Model.ExistingVerification.Status == 0)
            {
                <strong>⏳ Đang chờ xử lý</strong>
        
                <br>
                <strong>Yêu cầu xác minh của bạn đang được admin xem xét.Chúng tôi sẽ phản hồi trong vòng 24 - 48 giờ.</strong>
                }
            else if (Model.ExistingVerification.Status == 1)
            {
                <strong>✅ Đã xác minh thành công!</strong>
        
                <br>
                <strong>Danh tính của bạn đã được xác minh. Badge "Đã xác minh" đã được thêm vào hồ sơ.</strong>
                }
            else
            {
                <strong>❌ Yêu cầu bị từ chối</strong>
        
                <br>
                @if (!string.IsNullOrEmpty(Model.ExistingVerification.AdminNotes))
                {
                    <span>Lý do: @Model.ExistingVerification.AdminNotes</span>
        
                    <br>
                }
                <span>Vui lòng kiểm tra lại thông tin và gửi yêu cầu mới.</span>
            }
        </div>

        @if (Model.ExistingVerification.Status != 1)
        {
            <div style="text-align: center; margin-bottom: 30px;">
                <button onclick="showNewVerificationForm()" class="btn btn-primary">
                    📝 Gửi yêu cầu xác minh mới
                </button>
            </div>
        }
    }

    @if (Model.ExistingVerification == null || Model.ExistingVerification.Status == 2)
    {
        <div id="verification-form" style="@(Model.ExistingVerification?.Status == 2 ? "display: none;" : "")">
            <!-- Progress Steps -->
            <div class="verification-steps">
                <div class="step active">
                    <div class="step-number">1</div>
                    <div class="step-title">Thông tin cá nhân</div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-title">Tài liệu xác minh</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-title">Xác nhận & Gửi</div>
                </div>
            </div>

            <form method="post" enctype="multipart/form-data" id="verificationForm">
                <div asp-validation-summary="ModelOnly" class="alert alert-error"></div>

                <!-- Personal Information Section -->
                <div class="form-section">
                    <h3 class="section-title">
                        <span>👤</span>
                        Thông tin cá nhân
                    </h3>

                    <div class="requirements">
                        <h4>⚠️ Lưu ý quan trọng:</h4>
                        <ul>
                            <li>Thông tin phải khớp chính xác với CMND/CCCD</li>
                            <li>Họ tên phải viết đúng dấu tiếng Việt</li>
                            <li>Ngày sinh phải đúng định dạng trên giấy tờ</li>
                            <li>Địa chỉ nên là địa chỉ thường trú hoặc tạm trú</li>
                        </ul>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label asp-for="FullName">Họ và tên *</label>
                            <input asp-for="FullName" class="form-control" placeholder="Nguyễn Văn A" />
                            <span asp-validation-for="FullName" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="IdNumber">Số CMND/CCCD *</label>
                            <input asp-for="IdNumber" class="form-control" placeholder="123456789012" />
                            <span asp-validation-for="IdNumber" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="DateOfBirth">Ngày sinh *</label>
                            <input asp-for="DateOfBirth" class="form-control" type="date" />
                            <span asp-validation-for="DateOfBirth" class="text-danger"></span>
                        </div>

                        <div class="form-group form-group-full">
                            <label asp-for="Address">Địa chỉ thường trú *</label>
                            <textarea asp-for="Address" class="form-control" rows="3" placeholder="123 Đường ABC, Phường XYZ, Quận 1, TP.HCM"></textarea>
                            <span asp-validation-for="Address" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Document Upload Section -->
                <div class="form-section">
                    <h3 class="section-title">
                        <span>📄</span>
                        Tài liệu xác minh
                    </h3>

                    <div class="requirements">
                        <h4>📋 Yêu cầu ảnh chụp:</h4>
                        <ul>
                            <li>Ảnh rõ nét, không mờ, không bị cắt góc</li>
                            <li>Thông tin trên giấy tờ phải đọc được rõ ràng</li>
                            <li>Định dạng: JPG, PNG (tối đa 5MB mỗi ảnh)</li>
                            <li>Ảnh selfie: mặt rõ ràng, cầm CMND/CCCD bên cạnh</li>
                        </ul>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Mặt trước CMND/CCCD *</label>
                            <div class="file-upload">
                                <input type="file" name="FrontIdImage" accept="image/*" class="file-input" onchange="handleFileUpload(this, 'front-preview')" />
                                <div class="file-label" id="front-label">
                                    <div class="file-icon">🆔</div>
                                    <div class="file-text">
                                        <strong>Click để chọn ảnh mặt trước</strong><br>
                                        <small>JPG, PNG tối đa 5MB</small>
                                    </div>
                                    <img id="front-preview" class="file-preview" style="display: none;" />
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Mặt sau CMND/CCCD *</label>
                            <div class="file-upload">
                                <input type="file" name="BackIdImage" accept="image/*" class="file-input" onchange="handleFileUpload(this, 'back-preview')" />
                                <div class="file-label" id="back-label">
                                    <div class="file-icon">🆔</div>
                                    <div class="file-text">
                                        <strong>Click để chọn ảnh mặt sau</strong><br>
                                        <small>JPG, PNG tối đa 5MB</small>
                                    </div>
                                    <img id="back-preview" class="file-preview" style="display: none;" />
                                </div>
                            </div>
                        </div>

                        <div class="form-group form-group-full">
                            <label>Ảnh selfie cầm CMND/CCCD</label>
                            <div class="file-upload">
                                <input type="file" name="SelfieImage" accept="image/*" class="file-input" onchange="handleFileUpload(this, 'selfie-preview')" />
                                <div class="file-label" id="selfie-label">
                                    <div class="file-icon">🤳</div>
                                    <div class="file-text">
                                        <strong>Click để chọn ảnh selfie</strong><br>
                                        <small>Ảnh bạn cầm CMND/CCCD bên cạnh mặt (tùy chọn)</small>
                                    </div>
                                    <img id="selfie-preview" class="file-preview" style="display: none;" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Section -->
                <div class="form-section">
                    <h3 class="section-title">
                        <span>✅</span>
                        Xác nhận và gửi yêu cầu
                    </h3>

                    <div class="requirements">
                        <h4>📝 Cam kết:</h4>
                        <ul>
                            <li>Tôi xác nhận rằng tất cả thông tin cung cấp là chính xác và trung thực</li>
                            <li>Tôi hiểu rằng việc cung cấp thông tin sai sự thật có thể dẫn đến việc khóa tài khoản</li>
                            <li>Tôi đồng ý cho Mirrorly lưu trữ và xử lý thông tin này để mục đích xác minh</li>
                        </ul>
                    </div>

                    <div style="display: flex; align-items: center; margin: 20px 0;">
                        <input type="checkbox" id="agreement" required style="margin-right: 10px;" />
                        <label for="agreement" style="margin: 0; color: #374151;">
                            Tôi đồng ý với các điều khoản trên và xác nhận thông tin là chính xác
                        </label>
                    </div>

                    <div style="text-align: center; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <button type="button" onclick="history.back()" class="btn btn-secondary" style="margin-right: 15px;">
                            ← Hủy bỏ
                        </button>
                        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                            🚀 Gửi yêu cầu xác minh
                        </button>
                    </div>
                </div>
            </form>
        </div>
    }

    @if (Model.ExistingVerification?.Status == 1)
    {
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 64px; margin-bottom: 20px;">✅</div>
            <h2 style="color: #065f46; margin-bottom: 15px;">Xác minh thành công!</h2>
            <p style="color: #374151; margin-bottom: 30px;">
                Danh tính của bạn đã được xác minh. Hồ sơ của bạn giờ đây sẽ hiển thị badge "Đã xác minh"
                để tăng độ tin cậy với khách hàng.
            </p>
            <a href="/Profile/MuaProfile" class="btn btn-primary">
                👤 Xem hồ sơ của tôi
            </a>
        </div>
    }
</div>

<script>
    function handleFileUpload(input, previewId) {
        const file = input.files[0];
        const preview = document.getElementById(previewId);
        const label = input.nextElementSibling;

        if (file) {
            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File quá lớn. Vui lòng chọn ảnh nhỏ hơn 5MB.');
                input.value = '';
                return;
            }

            // Validate file type
            if (!file.type.match('image.*')) {
                alert('Vui lòng chọn file ảnh (JPG, PNG).');
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
                label.classList.add('has-file');

                // Hide the icon and text, show only preview
                const icon = label.querySelector('.file-icon');
                const text = label.querySelector('.file-text');
                icon.style.display = 'none';
                text.innerHTML = `<strong>${file.name}</strong><br><small>Click để thay đổi</small>`;
            };
            reader.readAsDataURL(file);
        }
    }

    function showNewVerificationForm() {
        document.getElementById('verification-form').style.display = 'block';
    }

    // Enable submit button when agreement is checked
    document.getElementById('agreement').addEventListener('change', function() {
        document.getElementById('submitBtn').disabled = !this.checked;
    });

    // Form validation before submit
    document.getElementById('verificationForm').addEventListener('submit', function(e) {
        const requiredFiles = ['FrontIdImage', 'BackIdImage'];
        const missingFiles = [];

        requiredFiles.forEach(fieldName => {
            const input = document.querySelector(`input[name="${fieldName}"]`);
            if (!input.files || input.files.length === 0) {
                missingFiles.push(fieldName === 'FrontIdImage' ? 'Ảnh mặt trước CMND/CCCD' : 'Ảnh mặt sau CMND/CCCD');
            }
        });

        if (missingFiles.length > 0) {
            e.preventDefault();
            alert('Vui lòng upload đầy đủ: ' + missingFiles.join(', '));
        }
    });
</script>