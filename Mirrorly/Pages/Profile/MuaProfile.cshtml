@page "/Profile/MuaProfile"
@model Mirrorly.Pages.Profile.MuaProfileModel
@{
    ViewData["Title"] = "Hồ sơ thợ trang điểm";
}

<style>
    .profile-container {
        max-width: 1200px;
        margin: 30px auto;
        padding: 20px;
    }

    .profile-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px;
        background: linear-gradient(135deg, #fdf2f8 0%, #fff0f6 100%);
        border-radius: 16px;
        border: 1px solid #fbcfe8;
    }

    .profile-title {
        color: #db2777;
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 15px;
    }

    .profile-status {
        display: inline-block;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 20px;
    }

    .profile-public {
        background: #d1fae5;
        color: #047857;
        border: 1px solid #6ee7b7;
    }

    .profile-private {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fbbf24;
    }

    .sections-container {
        display: grid;
        gap: 30px;
    }

    .section-card {
        background: white;
        border: 1px solid #fbcfe8;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(248, 187, 208, 0.1);
    }

    .section-header {
        background: linear-gradient(135deg, #db2777, #f472b6);
        color: white;
        padding: 20px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .section-title {
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-content {
        padding: 25px;
    }

    /* Form Styles */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group-full {
        grid-column: 1 / -1;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #be185d;
        font-weight: 500;
        font-size: 14px;
    }

    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #f8bbd0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
        box-sizing: border-box;
    }

    .form-control:focus {
        outline: none;
        border-color: #db2777;
        box-shadow: 0 0 8px rgba(219, 39, 119, 0.2);
    }

    .form-control-textarea {
        min-height: 100px;
        resize: vertical;
        font-family: inherit;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
    }

    /* Services Management */
    .services-list {
        display: grid;
        gap: 15px;
        margin-bottom: 20px;
    }

    .service-item {
        background: #fdf2f8;
        border: 1px solid #fbcfe8;
        border-radius: 12px;
        padding: 20px;
        position: relative;
    }

    .service-header {
        display: flex;
        justify-content: between;
        align-items: flex-start;
        margin-bottom: 15px;
    }

    .service-info {
        flex: 1;
    }

    .service-actions {
        display: flex;
        gap: 8px;
    }

    .service-form {
        display: none;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #fbcfe8;
    }

    .service-form.active {
        display: grid;
    }

    /* Portfolio Management */
    .portfolio-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .portfolio-item {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #fbcfe8;
        background: white;
    }

    .portfolio-item img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }

    .portfolio-info {
        padding: 15px;
    }

    .portfolio-actions {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 5px;
    }

    .portfolio-form {
        display: none;
        background: #fdf2f8;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #fbcfe8;
        margin-bottom: 20px;
    }

    .portfolio-form.active {
        display: block;
    }

    /* Working Hours */
    .working-hours-grid {
        display: grid;
        gap: 15px;
    }

    .day-schedule {
        display: grid;
        grid-template-columns: 100px 1fr 1fr 80px;
        gap: 15px;
        align-items: center;
        padding: 15px;
        background: #fdf2f8;
        border-radius: 8px;
        border: 1px solid #fbcfe8;
    }

    .day-label {
        font-weight: 600;
        color: #db2777;
    }

    /* Buttons */
    .btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        font-size: 14px;
    }

    .btn-primary {
        background: #db2777;
        color: white;
    }

    .btn-primary:hover {
        background: #be185d;
    }

    .btn-secondary {
        background: #f8bbd0;
        color: #be185d;
        border: 1px solid #f8bbd0;
    }

    .btn-secondary:hover {
        background: #fbcfe8;
    }

    .btn-danger {
        background: #dc2626;
        color: white;
    }

    .btn-danger:hover {
        background: #b91c1c;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }

    .btn-add {
        background: #10b981;
        color: white;
        margin-bottom: 20px;
    }

    .btn-add:hover {
        background: #059669;
    }

    /* Success/Error Messages */
    .alert {
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-weight: 500;
    }

    .alert-success {
        background: #d1fae5;
        color: #047857;
        border: 1px solid #6ee7b7;
    }

    .alert-danger {
        background: #fee2e2;
        color: #dc2626;
        border: 1px solid #fca5a5;
    }

</style>

<div class="profile-container">
    <!-- Header Section -->
    <div class="profile-header">
        <h1 class="profile-title">Quản lý Hồ sơ thợ trang điểm</h1>
        
        <div class="profile-status @(Model.ProfilePublic ? "profile-public" : "profile-private")">
            @if (Model.ProfilePublic)
            {
                <span>✅ Hồ sơ công khai - Khách hàng có thể tìm thấy bạn</span>
            }
            else
            {
                <span>⚠️ Hồ sơ riêng tư - Hãy hoàn thiện thông tin để công khai</span>
            }
        </div>
        
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success">@TempData["SuccessMessage"]</div>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
        }
    </div>

    <div class="sections-container">
        <!-- Basic Information Section -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span>👤</span>
                    <span>Thông tin cơ bản</span>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="toggleSection('basic-info')">
                    <span id="basic-info-toggle">Chỉnh sửa</span>
                </button>
            </div>
            <div class="section-content">
                <form method="post" asp-page-handler="UpdateBasicInfo" id="basic-info-form">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label asp-for="DisplayName">Tên hiển thị *</label>
                            <input asp-for="DisplayName" class="form-control" readonly />
                            <span asp-validation-for="DisplayName" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="ExperienceYears">Năm kinh nghiệm</label>
                            <input asp-for="ExperienceYears" class="form-control" type="number" min="0" max="50" readonly />
                        </div>

                        <div class="form-group form-group-full">
                            <label asp-for="AddressLine">Địa chỉ làm việc</label>
                            <input asp-for="AddressLine" class="form-control" readonly />
                        </div>

                        <div class="form-group form-group-full">
                            <label asp-for="Bio">Giới thiệu bản thân</label>
                            <textarea asp-for="Bio" class="form-control form-control-textarea" readonly></textarea>
                        </div>

                        <div class="form-group form-group-full">
                            <div class="checkbox-group">
                                <input asp-for="ProfilePublic" type="checkbox" id="profilePublic" disabled />
                                <label for="profilePublic">Công khai hồ sơ cho khách hàng</label>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: right; display: none;" id="basic-info-actions">
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit('basic-info')">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Services Management Section -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span>📋</span>
                    <span>Dịch vụ & Bảng giá (@Model.Services.Count dịch vụ)</span>
                </div>
                <button class="btn btn-add btn-sm" onclick="toggleAddService()">
                    <span id="add-service-text">+ Thêm dịch vụ</span>
                </button>
            </div>
            <div class="section-content">
                <!-- Add Service Form -->
                <div class="portfolio-form" id="add-service-form">
                    <h4 style="color: #db2777; margin-bottom: 20px;">Thêm dịch vụ mới</h4>
                    <form method="post" asp-page-handler="AddService">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Tên dịch vụ *</label>
                                <input name="ServiceName" class="form-control" required />
                            </div>
                            <div class="form-group">
                                <label>Danh mục</label>
                                <select name="CategoryId" class="form-control">
                                    <option value="">-- Chọn danh mục --</option>
                                    @foreach (var category in Model.Categories)
                                    {
                                        <option value="@category.CategoryId">@category.CategoryName</option>
                                    }
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Giá (VNĐ) *</label>
                                <input name="BasePrice" class="form-control" type="number" min="0" required />
                            </div>
                            <div class="form-group">
                                <label>Thời gian (phút)</label>
                                <input name="DurationMin" class="form-control" type="number" min="30" value="90" />
                            </div>
                            <div class="form-group form-group-full">
                                <label>Mô tả dịch vụ</label>
                                <textarea name="Description" class="form-control form-control-textarea"></textarea>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <button type="button" class="btn btn-secondary" onclick="toggleAddService()">Hủy</button>
                            <button type="submit" class="btn btn-primary">Thêm dịch vụ</button>
                        </div>
                    </form>
                </div>

                <!-- Services List -->
                <div class="services-list">
                    @foreach (var service in Model.Services)
                    {
                        <div class="service-item" id="service-@service.ServiceId">
                            <div class="service-header">
                                <div class="service-info">
                                    <h4 style="color: #db2777; margin-bottom: 8px;">@service.Name</h4>
                                    <p style="color: #6b7280; margin-bottom: 10px;">@service.Description</p>
                                    <div style="display: flex; gap: 20px; font-size: 14px; color: #be185d;">
                                        <span><strong>💰 @service.BasePrice.ToString("N0") VNĐ</strong></span>
                                        <span>⏱ @service.DurationMin phút</span>
                                        @if (service.Category != null)
                                        {
                                            <span>📂 @service.Category.CategoryName</span>
                                        }
                                        <span class="@(service.Active ? "text-success" : "text-muted")">
                                            @(service.Active ? "🟢 Đang hoạt động" : "🔴 Tạm dừng")
                                        </span>
                                    </div>
                                </div>
                                <div class="service-actions">
                                    <button class="btn btn-secondary btn-sm" onclick="editService(@service.ServiceId)">
                                        ✏️ Sửa
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteService(@service.ServiceId)">
                                        🗑️ Xóa
                                    </button>
                                </div>
                            </div>

                            <!-- Edit Service Form (Hidden by default) -->
                            <div class="service-form" id="edit-service-@service.ServiceId">
                                <form method="post" asp-page-handler="UpdateService">
                                    <input type="hidden" name="ServiceId" value="@service.ServiceId" />
                                    <div class="form-group">
                                        <label>Tên dịch vụ</label>
                                        <input name="ServiceName" value="@service.Name" class="form-control" />
                                    </div>
                                    <div class="form-group">
                                        <label>Giá (VNĐ)</label>
                                        <input name="BasePrice" value="@service.BasePrice" class="form-control" type="number" />
                                    </div>
                                    <div class="form-group">
                                        <label>Thời gian (phút)</label>
                                        <input name="DurationMin" value="@service.DurationMin" class="form-control" type="number" />
                                    </div>
                                    <div class="form-group">
                                        <label>Trạng thái</label>
                                        <select name="Active" class="form-control">
                                            <option value="true" selected="@(service.Active ? "selected" : null)">Hoạt động</option>
                                            <option value="false" selected="@(!service.Active ? "selected" : null)">Tạm dừng</option>
                                        </select>
                                    </div>
                                    <div class="form-group form-group-full">
                                        <label>Mô tả</label>
                                        <textarea name="Description" class="form-control">@service.Description</textarea>
                                    </div>
                                    <div style="text-align: right; margin-top: 15px;">
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="cancelEditService(@service.ServiceId)">Hủy</button>
                                        <button type="submit" class="btn btn-primary btn-sm">Cập nhật</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    }
                </div>

                @if (!Model.Services.Any())
                {
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p>🎨 Chưa có dịch vụ nào được thêm</p>
                        <p>Hãy thêm dịch vụ đầu tiên của bạn!</p>
                    </div>
                }
            </div>
        </div>

        <!-- Portfolio Section -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span>🎨</span>
                    <span>Portfolio (@Model.Portfolios.Count hình ảnh)</span>
                </div>
                <button class="btn btn-add btn-sm" onclick="toggleAddPortfolio()">
                    <span id="add-portfolio-text">+ Thêm hình ảnh</span>
                </button>
            </div>
            <div class="section-content">
                <!-- Add Portfolio Form -->
                <div class="portfolio-form" id="add-portfolio-form">
                    <h4 style="color: #db2777; margin-bottom: 20px;">Thêm hình ảnh mới</h4>
                    <form method="post" asp-page-handler="AddPortfolio">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Tiêu đề *</label>
                                <input name="Title" class="form-control" required />
                            </div>
                            <div class="form-group">
                                <label>URL hình ảnh *</label>
                                <input name="MediaUrl" class="form-control" type="url" required />
                            </div>
                            <div class="form-group form-group-full">
                                <label>Mô tả</label>
                                <textarea name="Description" class="form-control"></textarea>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <button type="button" class="btn btn-secondary" onclick="toggleAddPortfolio()">Hủy</button>
                            <button type="submit" class="btn btn-primary">Thêm hình ảnh</button>
                        </div>
                    </form>
                </div>

                <!-- Portfolio Grid -->
                <div class="portfolio-grid">
                    @foreach (var item in Model.Portfolios)
                    {
                        <div class="portfolio-item">
                            <img src="@item.MediaUrl" alt="@item.Title" onerror="this.src='/images/placeholder.jpg'" />
                            <div class="portfolio-info">
                                <h5 style="margin: 0 0 5px 0; color: #db2777;">@item.Title</h5>
                                <p style="margin: 0; font-size: 12px; color: #6b7280;">@item.Description</p>
                            </div>
                            <div class="portfolio-actions">
                                <button class="btn btn-danger btn-sm" onclick="deletePortfolio(@item.ItemId)" 
                                        style="padding: 4px 8px; font-size: 11px;">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    }
                </div>

                @if (!Model.Portfolios.Any())
                {
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p>📷 Chưa có hình ảnh portfolio nào</p>
                        <p>Hãy thêm những tác phẩm đẹp nhất của bạn!</p>
                    </div>
                }
            </div>
        </div>

        <!-- Working Hours Section -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span>⏰</span>
                    <span>Lịch làm việc</span>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="toggleSection('working-hours')">
                    <span id="working-hours-toggle">Chỉnh sửa</span>
                </button>
            </div>
            <div class="section-content">
                <form method="post" asp-page-handler="UpdateWorkingHours" id="working-hours-form">
                    <div class="working-hours-grid">
                        @{
                            var daysOfWeek = new Dictionary<byte, string>
                            {
                                {1, "Thứ 2"}, {2, "Thứ 3"}, {3, "Thứ 4"}, {4, "Thứ 5"},
                                {5, "Thứ 6"}, {6, "Thứ 7"}, {7, "Chủ nhật"}
                            };
                        }

                        @for (byte day = 1; day <= 7; day++)
                        {
                            var workingHour = Model.WorkingHours.FirstOrDefault(w => w.DayOfWeek == day);
                            <div class="day-schedule">
                                <div class="day-label">@daysOfWeek[day]</div>
                                <input type="time" name="StartTime_@day" value="@(workingHour?.StartTime.ToString(@"hh\:mm"))" 
                                       class="form-control" readonly />
                                <input type="time" name="EndTime_@day" value="@(workingHour?.EndTime.ToString(@"hh\:mm"))" 
                                       class="form-control" readonly />
                                <div class="checkbox-group">
                                    <input type="checkbox" name="IsWorking_@day" value="true" 
                                           checked="@(workingHour != null)" id="working_@day" disabled />
                                    <label for="working_@day" style="margin: 0; font-size: 12px;">Làm việc</label>
                                </div>
                            </div>
                        }
                    </div>

                    <div style="text-align: right; margin-top: 20px; display: none;" id="working-hours-actions">
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit('working-hours')">Hủy</button>
                        <button type="submit" class="btn btn-primary">Cập nhật lịch</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Toggle section editing
    function toggleSection(sectionName) {
        const form = document.getElementById(`${sectionName}-form`);
        const inputs = form.querySelectorAll('input, textarea, select');
        const actions = document.getElementById(`${sectionName}-actions`);
        const toggle = document.getElementById(`${sectionName}-toggle`);
        
        const isReadonly = inputs[0].hasAttribute('readonly') || inputs[0].hasAttribute('disabled');
        
        inputs.forEach(input => {
            if (isReadonly) {
                input.removeAttribute('readonly');
                input.removeAttribute('disabled');
            } else {
                if (input.type === 'checkbox') {
                    input.setAttribute('disabled', 'disabled');
                } else {
                    input.setAttribute('readonly', 'readonly');
                }
            }
        });
        
        if (isReadonly) {
            actions.style.display = 'block';
            toggle.textContent = 'Hủy';
        } else {
            actions.style.display = 'none';
            toggle.textContent = 'Chỉnh sửa';
        }
    }
    
    function cancelEdit(sectionName) {
        location.reload(); // Simple way to reset form
    }
    
    // Service management
    function toggleAddService() {
        const form = document.getElementById('add-service-form');
        const text = document.getElementById('add-service-text');
        
        if (form.style.display === 'none' || !form.style.display) {
            form.style.display = 'block';
            text.textContent = 'Hủy';
        } else {
            form.style.display = 'none';
            text.textContent = '+ Thêm dịch vụ';
        }
    }
    
    function editService(serviceId) {
        const form = document.getElementById(`edit-service-${serviceId}`);
        form.classList.toggle('active');
    }
    
    function cancelEditService(serviceId) {
        const form = document.getElementById(`edit-service-${serviceId}`);
        form.classList.remove('active');
    }
    
    function deleteService(serviceId) {
        if (confirm('Bạn có chắc muốn xóa dịch vụ này?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/Profile/MuaProfile?handler=DeleteService';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'serviceId';
            input.value = serviceId;
            
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    }
    
    // Portfolio management
    function toggleAddPortfolio() {
        const form = document.getElementById('add-portfolio-form');
        const text = document.getElementById('add-portfolio-text');
        
        if (form.style.display === 'none' || !form.style.display) {
            form.style.display = 'block';
            text.textContent = 'Hủy';
        } else {
            form.style.display = 'none';
            text.textContent = '+ Thêm hình ảnh';
        }
    }
    
    function deletePortfolio(itemId) {
        if (confirm('Bạn có chắc muốn xóa hình ảnh này?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/Profile/MuaProfile?handler=DeletePortfolio';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'itemId';
            input.value = itemId;
            
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>